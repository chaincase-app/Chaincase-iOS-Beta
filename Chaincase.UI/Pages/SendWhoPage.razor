@page "/send/who"
@using Microsoft.AspNetCore.Components
@using Chaincase.Common
@using Chaincase.Common.Contracts
@using Chaincase.UI.Services
@inject Global Global
@inject SendViewModel SendViewModel
@inject UIStateService UiStateService
@inject NavigationManager NavigationManager
@inject StackService StackService
@inject IJSRuntime JsRuntime
@inject IClipboard Clipboard
@inherits ReactiveComponentBase<SendViewModel>

<IonContent class="ion-padding">
    <h1>Sending to who?</h1>

    <IonItem>
        <IonLabel position="stacked">Address or <code>bitcoin:</code> uri</IonLabel>
        <IonInput @bind-Value="ViewModel.DestinationString" placeholder="Enter address..." />
    </IonItem>
    <IonItem>
        <IonButton OnClick="OnClickPaste">
            <IonIcon slot="start" name="clipboard-outline"/>
            Paste
        </IonButton>
        <IonButton OnClick="OnClickScan">
            <IonIcon slot="start" name="scan-outline"/>
            Scan QR Code
        </IonButton>
    </IonItem>
    <IonButton OnClick="OnContinue" expand="block" disabled="@(!IsAddressValid)">NEXT</IonButton>

</IonContent>

@code {

    private string Label { get; set; }

    private string _addressString;

    private bool IsAddressValid => ViewModel.DestinationUrl?.Address is not null;

    protected override void OnInitialized()
    {
        ViewModel = SendViewModel;
        UiStateService.Title = "SEND";
    }

    private async Task OnClickScan()
    {
        var scanner = new ZXing.Mobile.MobileBarcodeScanner();
        var result = await scanner.Scan();

        if (result != null)
        { ViewModel.DestinationString = result.Text; }
    }

    private async Task OnClickPaste()
    {
        ViewModel.DestinationString = await Clipboard.Paste();
    }

    public void OnContinue()
    {
        StackService.PushStackState(async () =>
        {
            await NavigationManager.NavigateBack(JsRuntime, "/send/who");
        });
        NavigationManager.NavigateTo("/send/label");
    }

}
